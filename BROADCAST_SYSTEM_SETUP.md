# üì¢ –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

## ‚úÖ –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ:

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤ `C:\dev\de-web\sql-migrations\001_create_broadcasts.sql`
- ‚úÖ –¢–∞–±–ª–∏—Ü—ã: `broadcasts`, `broadcast_deliveries`
- ‚úÖ Enum –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤: draft, scheduled, sending, completed, failed
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 2. Prisma Schema
- ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `schema.prisma` —Å –º–æ–¥–µ–ª—è–º–∏ Broadcast –∏ BroadcastDelivery
- ‚úÖ Enum BroadcastStatus –¥–æ–±–∞–≤–ª–µ–Ω

### 3. –ê–¥–º–∏–Ω–∫–∞ (Next.js)
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/dream/broadcasts` —Å —Ç–∞–±–ª–∏—Ü–µ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- ‚úÖ –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
- ‚úÖ API endpoints:
  - `POST /api/broadcasts` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
  - `POST /api/broadcasts/send` - –∑–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–∫–∏
  - `DELETE /api/broadcasts/[id]` - —É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
- ‚úÖ –ü—É–Ω–∫—Ç –º–µ–Ω—é "–†–∞—Å—Å—ã–ª–∫–∏" –≤ sidebar

### 4. –ë–æ—Ç (Node.js)
- ‚úÖ `broadcastHandler.js` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–∞—Å—Å—ã–ª–æ–∫
- ‚úÖ API endpoints –≤ `index.js`:
  - `POST /api/broadcast/start` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
  - `GET /api/broadcast/:id/status` - —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ª–∏–º–∏—Ç–æ–≤ Telegram (30 msg/sec)

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é:

### –®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏ SQL –º–∏–≥—Ä–∞—Ü–∏—é

–û—Ç–∫—Ä–æ–π **pgAdmin4**, –ø–æ–¥–∫–ª—é—á–∏—Å—å –∫ –ë–î –∏ –≤—ã–ø–æ–ª–Ω–∏:

```sql
-- –§–∞–π–ª: C:\dev\de-web\sql-migrations\001_create_broadcasts.sql
-- –°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏ –≤ Query Tool
```

–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:
```sql
SELECT * FROM broadcasts;
SELECT * FROM broadcast_deliveries;
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏ Prisma Client

```bash
cd C:\dev\de-web
npx prisma generate
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∞–¥–º–∏–Ω–∫—É

```bash
# –í C:\dev\de-web
npm run dev
```

–û—Ç–∫—Ä–æ–π: http://localhost:3001/dream/broadcasts

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (—á–µ—Ä–µ–∑ SSH –∏–ª–∏ Timeweb)
pm2 restart emotion-design-bot
pm2 logs emotion-design-bot
```

–ò–ª–∏ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å Timeweb: –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å "–ë–æ—Ç –î–∏–∑–∞–π–Ω –≠–º–æ—Ü–∏–π"

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í –∞–¥–º–∏–Ω–∫–µ –¥–æ–±–∞–≤—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è URL –±–æ—Ç–∞:

```env
# –í .env –∞–¥–º–∏–Ω–∫–∏
BOT_WEBHOOK_URL=https://your-bot-domain.ru
```

–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `http://localhost:3002`

---

## üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### 1. –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É:
1. –û—Ç–∫—Ä–æ–π http://localhost:3001/dream/broadcasts
2. –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É"
3. –ó–∞–ø–æ–ª–Ω–∏:
   - **–ó–∞–≥–æ–ª–æ–≤–æ–∫** (–¥–ª—è –∞–¥–º–∏–Ω–∫–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç)
   - **–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Å —ç–º–æ–¥–∑–∏)
   - **URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - **–ö–Ω–æ–ø–∫–∞** (—Ç–µ–∫—Å—Ç + —Å—Å—ã–ª–∫–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –ü–æ—Å–º–æ—Ç—Ä–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
5. –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫"

### 2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É:
1. –ù–∞–π–¥–∏ —Ä–∞—Å—Å—ã–ª–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ß–µ—Ä–Ω–æ–≤–∏–∫"
2. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚ñ∂ (Play)
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –æ—Ç–ø—Ä–∞–≤–∫—É
4. –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏—Ç—Å—è –Ω–∞ "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è"
5. –ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
6. –ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è - —Å—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–µ—Ç "–ó–∞–≤–µ—Ä—à–µ–Ω–∞"

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
- **–í—Å–µ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫** - —Å–∫–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–æ
- **–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö** - —É—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
- **–í –ø—Ä–æ—Ü–µ—Å—Å–µ** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å
- **–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

–í —Ç–∞–±–ª–∏—Ü–µ –≤–∏–¥–Ω–æ:
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ / –í—Å–µ–≥–æ
- üìä –£—Å–ø–µ—à–Ω–æ—Å—Ç—å (–∑–µ–ª—ë–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞)
- ‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
- üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

---

## üéØ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—Å—ã–ª–æ–∫:

### –ù–æ–≤–æ—Å—Ç—å:
```
–ó–∞–≥–æ–ª–æ–≤–æ–∫: –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
–°–æ–æ–±—â–µ–Ω–∏–µ:
üéâ –î–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é!

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ PDF.

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
```

### –ê–∫—Ü–∏—è:
```
–ó–∞–≥–æ–ª–æ–≤–æ–∫: –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
–°–æ–æ–±—â–µ–Ω–∏–µ:
üíé –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ!

–¢–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è - –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–º–∏—É–º-–∫—É—Ä—Å—É —Å–æ —Å–∫–∏–¥–∫–æ–π 50%.

–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: https://example.com/promo.jpg
–ö–Ω–æ–ø–∫–∞: –ü–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É ‚Üí https://t.me/your_bot?start=promo
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞:
```
–ó–∞–≥–æ–ª–æ–≤–æ–∫: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞
–°–æ–æ–±—â–µ–Ω–∏–µ:
üìö –û–±–Ω–æ–≤–∏–ª–∏ –∫—É—Ä—Å "–î–Ω–µ–≤–Ω–∏–∫ –≠–º–æ—Ü–∏–π"!

–î–æ–±–∞–≤–∏–ª–∏ 5 –Ω–æ–≤—ã—Ö —É—Ä–æ–∫–æ–≤ –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.

–ö–Ω–æ–ø–∫–∞: –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫—É—Ä—Å ‚Üí https://t.me/your_bot?start=course
```

---

## ‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:

### –õ–∏–º–∏—Ç—ã Telegram:
- 30 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
- –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É 35ms –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏

### –°—Ç–∞—Ç—É—Å—ã —Ä–∞—Å—Å—ã–ª–∫–∏:
- **draft** - —á–µ—Ä–Ω–æ–≤–∏–∫, –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
- **scheduled** - –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –±—É–¥—É—â–µ–µ (–ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)
- **sending** - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
- **completed** - –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- **failed** - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏:
–ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ –≤ —Ç–∞–±–ª–∏—Ü–µ `broadcast_deliveries`:
- ‚úÖ delivered = true - –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
- ‚ùå delivered = false + error_message - –æ—à–∏–±–∫–∞

### –§–∏–ª—å—Ç—Ä—ã –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (–Ω–∞ –±—É–¥—É—â–µ–µ):
–í –ø–æ–ª–µ `target_filters` –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å JSON:
```json
{
  "is_program_active": true,
  "min_checkins": 5,
  "language": "ru"
}
```
–ü–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º —Å `notificationsEnabled = true`

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

### 1. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏:
```bash
curl -X POST http://localhost:3001/api/broadcasts \
  -H "Content-Type: application/json" \
  -d '{
    "title": "–¢–µ—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞",
    "message": "–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ —Ç–µ—Å—Ç üëã"
  }'
```

### 2. –ü—Ä–æ–≤–µ—Ä—å –∑–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–∫–∏:
```bash
curl -X POST http://localhost:3001/api/broadcasts/send \
  -H "Content-Type: application/json" \
  -d '{
    "broadcastId": "YOUR_BROADCAST_ID"
  }'
```

### 3. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –±–æ—Ç–µ:
```bash
curl http://your-bot-url/api/broadcast/YOUR_BROADCAST_ID/status
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

### –õ–æ–≥–∏ –∞–¥–º–∏–Ω–∫–∏:
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω–∞ –∞–¥–º–∏–Ω–∫–∞
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
# ‚úÖ POST /api/broadcasts 201
# ‚úÖ POST /api/broadcasts/send 200
```

### –õ–æ–≥–∏ –±–æ—Ç–∞:
```bash
pm2 logs emotion-design-bot

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
# üì¢ Starting broadcast xxx for 7 users
# ‚úÖ Broadcast xxx: sent to 123456 (1/7)
# üéâ Broadcast xxx completed: 7 sent, 0 failed (100.0%)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:
```sql
-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
SELECT * FROM broadcasts ORDER BY created_at DESC LIMIT 5;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
SELECT 
  b.title,
  b.status,
  b.sent_count,
  b.failed_count,
  b.success_rate
FROM broadcasts b
ORDER BY b.created_at DESC;

-- –î–µ—Ç–∞–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
SELECT 
  u.first_name,
  bd.delivered,
  bd.error_message
FROM broadcast_deliveries bd
JOIN users u ON bd.user_id = u.id
WHERE bd.broadcast_id = 'YOUR_BROADCAST_ID';
```

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—ã–ª–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
‚úÖ –ê–¥–º–∏–Ω–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å
‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã

–ü–µ—Ä–≤—É—é —Ç–µ—Å—Ç–æ–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! üöÄ
